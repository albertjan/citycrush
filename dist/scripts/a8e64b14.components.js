(function(){window.EmberCouchDBKit=Ember.Namespace.create({VERSION:"0.9"})}).call(this),function(){EmberCouchDBKit.AttachmentSerializer=DS.RESTSerializer.extend({primaryKey:"id",normalize:function(a,b){var c,d;return d=this,c=b._rev||b.rev,this.store.find(b.model_name,b.doc_id).then(function(a){return a.get("_data.rev")!==c&&d.getIntRevision(a.get("_data.rev"))<d.getIntRevision(c)?a.set("_data.rev",c):void 0}),this._super(a,b)},getIntRevision:function(a){return parseInt(a.split("-")[0])},normalizeId:function(a){return a.id=a._id||a.id}}),EmberCouchDBKit.AttachmentAdapter=DS.Adapter.extend({find:function(a,b,c){return new Ember.RSVP.Promise(function(a){return Ember.run(null,a,{attachment:EmberCouchDBKit.AttachmentStore.get(c)})})},findMany:function(a,b,c){var d,e=this;return d=c.map(function(a){return a=EmberCouchDBKit.AttachmentStore.get(a),a.db=e.get("db"),a}),new Ember.RSVP.Promise(function(a){return Ember.run(null,a,{attachments:d})})},createRecord:function(a,b,c){var d,e;return e="%@/%@?rev=%@".fmt(this.buildURL(),c.get("id"),c.get("rev")),d=this,new Ember.RSVP.Promise(function(a){var b,f;return b={},b.context=d,f=new XMLHttpRequest,f.open("PUT",e,!0),f.setRequestHeader("Content-Type",c.get("content_type")),d._updateUploadState(c,f),f.onreadystatechange=function(){var e;return 4!==f.readyState||201!==f.status&&200!==f.status?void 0:(b=JSON.parse(f.response),b.model_name=c.get("model_name"),b.doc_id=c.get("doc_id"),e=d.serialize(c,{includeId:!0}),delete b.id,Ember.run(null,a,{attachment:$.extend(e,b)}))},f.send(c.get("file"))})},updateRecord:function(){},deleteRecord:function(){return new Ember.RSVP.Promise(function(a){return Ember.run(null,a,{})})},_updateUploadState:function(a,b){var c;return c=a.get("view"),c?(c.startUpload(),b.onprogress=function(a){var b;return a.lengthComputable?(b=100*(a.loaded/a.total),c.updateUpload(b)):void 0}):void 0},buildURL:function(){var a,b,c;return a=Ember.get(this,"host"),b=Ember.get(this,"namespace"),c=[],a&&c.push(a),b&&c.push(b),c.push(this.get("db")),c=c.join("/"),a||(c="/"+c),c}})}.call(this),function(){EmberCouchDBKit.ChangesFeed=Ember.ObjectProxy.extend({content:{},longpoll:function(){return this.feed="longpoll",this._ajax.apply(this,arguments)},normal:function(){return this.feed="normal",this._ajax.apply(this,arguments)},continuous:function(){return this.feed="continuous",this._ajax.apply(this,arguments)},fromTail:function(a){var b=this;return $.ajax({url:"%@%@/_changes?descending=true&limit=1".fmt(this._buildUrl(),this.get("db")),dataType:"json",success:function(c){return b.set("since",c.last_seq),a?a.call(b):void 0}})},stop:function(){return this.set("stopTracking",!0),this},start:function(a){return this.set("stopTracking",!1),this.fromTail(a)},_ajax:function(a,b){var c=this;return $.ajax({type:"GET",url:this._makeRequestPath(),dataType:"json",success:function(d){var e;return c.get("stopTracking")?void 0:((null!=d?null!=(e=d.results)?e.length:void 0:void 0)&&a&&a.call(b,d.results),c.set("since",d.last_seq),c._ajax(a,b))}})},_buildUrl:function(){var a;return a=this.get("host")||"/","/"!==a.substring(a.length-1)&&(a+="/"),a},_makeRequestPath:function(){var a,b;return a=this.feed||"longpool",b=this._makeFeedParams(),"%@%@/_changes?feed=%@%@".fmt(this._buildUrl(),this.get("db"),a,b)},_makeFeedParams:function(){var a,b=this;return a="",["include_docs","limit","descending","heartbeat","timeout","filter","filter_param","style","since"].forEach(function(c){return b.get(c)?a+="&%@=%@".fmt(c,b.get(c)):void 0}),a}})}.call(this),function(){EmberCouchDBKit.DocumentSerializer=DS.RESTSerializer.extend({primaryKey:"_id",normalize:function(a,b,c){return this.normalizeId(b),this.normalizeAttachments(b._attachments,a.typeKey,b),this.addHistoryId(b),this.normalizeUsingDeclaredMapping(a,b),this.normalizeAttributes(a,b),this.normalizeRelationships(a,b),this.normalizeHash&&this.normalizeHash[c]?this.normalizeHash[c](b):b?(this.applyTransforms(a,b),b):b},extractSingle:function(a,b,c,d,e){return this._super(a,b,c,d,e)},serialize:function(a,b){return this._super(a,b)},addHistoryId:function(a){return a.history="%@/history".fmt(a.id)},normalizeAttachments:function(a,b,c){var d,e,f,g,h;h=[];for(e in a)g=a[e],f=""+c._id+"/"+e,d={id:f,content_type:g.content_type,digest:g.digest,length:g.length,stub:g.stub,doc_id:c._id,rev:c.rev,file_name:e,model_name:b,revpos:g.revpos,db:g.db},EmberCouchDBKit.AttachmentStore.add(f,d),h.push(f);return c.attachments=h},normalizeId:function(a){return a.id=a._id||a.id},normalizeRelationships:function(a,b){var c,d;return d=void 0,c=void 0,this.keyForRelationship?a.eachRelationship(function(a,c){return d=this.keyForRelationship(a,c.kind),a!==d?(b[a]=b[d],delete b[d]):void 0},this):void 0},serializeBelongsTo:function(a,b,c){var d,e,f;return d=c.options.attribute||"id",f=c.key,e=Ember.get(a,f),Ember.isNone(e)?void 0:(b[f]=Ember.get(e,d),c.options.polymorphic?b[f+"_type"]=e.constructor.typeKey:void 0)},serializeHasMany:function(a,b,c){var d,e,f;switch(d=c.options.attribute||"id",e=c.key,f=DS.RelationshipChange.determineRelationshipType(a.constructor,c)){case"manyToNone":case"manyToMany":case"manyToOne":if(Ember.get(a,e).get("isLoaded"))return b[e]=Ember.get(a,e).mapBy(d);if(a.get("_data.%@".fmt(e)))return b[e]=a.get("_data.%@".fmt(e)).mapBy("id")}}}),EmberCouchDBKit.DocumentAdapter=DS.Adapter.extend({customTypeLookup:!1,typeViewName:"all",buildURL:function(){var a,b,c;return a=Ember.get(this,"host"),b=Ember.get(this,"namespace"),c=[],a&&c.push(a),b&&c.push(b),c.push(this.get("db")),c=c.join("/"),a||(c="/"+c),c},ajax:function(a,b,c,d){return this._ajax("%@/%@".fmt(this.buildURL(),a||""),b,c,d)},_ajax:function(a,b,c,d){var e;return null==d&&(d={}),e=this,new Ember.RSVP.Promise(function(f,g){var h;return""===a.split("/").pop()&&(a=a.substr(0,a.length-1)),d.url=a,d.type=b,d.dataType="json",d.contentType="application/json; charset=utf-8",d.context=e,d.data&&"GET"!==b&&(d.data=JSON.stringify(d.data)),e.headers&&(h=e.headers,d.beforeSend=function(a){return forEach.call(Ember.keys(h),function(b){return a.setRequestHeader(b,h[b])})}),d.success||(d.success=function(a){var b;return b=c.call(e,a),Ember.run(null,f,b)}),d.error=function(a){return a&&(a.then=null),Ember.run(null,g,a)},Ember.$.ajax(d)})},_normalizeRevision:function(a){return a&&a._rev&&(a.rev=a._rev,delete a._rev),a},shouldCommit:function(){return this._super.apply(arguments)},find:function(a,b,c){var d;return this._checkForRevision(c)?this.findWithRev(a,b,c):(d=function(a){var c;return this._normalizeRevision(a),c={},c[b.typeKey]=a,c},this.ajax(c,"GET",d))},findWithRev:function(a,b,c,d){var e,f,g,h,i;return h=c.split("/").slice(0,2),g=h[0],i=h[1],f="%@?rev=%@".fmt(g,i),e=function(a){var d;return this._normalizeRevision(a),d={},a._id=c,d[b.typeKey]=a,d},this.ajax(f,"GET",e,d)},findManyWithRev:function(a,b,c){var d,e,f,g,h=this;return f=Ember.String.pluralize(b.typeKey),g=this,d={},d[f]=[],e={async:!1},c.forEach(function(a){var b,c,i,j;return i=a.split("/").slice(0,2),c=i[0],j=i[1],b="%@?rev=%@".fmt(c,j),b="%@/%@".fmt(h.buildURL(),b),e.url=b,e.type="GET",e.dataType="json",e.contentType="application/json; charset=utf-8",e.success=function(b){return b._id=a,g._normalizeRevision(b),d[f].push(b)},Ember.$.ajax(e)}),d},findMany:function(a,b,c){var d,e;return this._checkForRevision(c[0])?this.findManyWithRev(a,b,c):(d={include_docs:!0,keys:c},e=function(a){var c,d=this;return c={},c[Ember.String.pluralize(b.typeKey)]=a.rows.getEach("doc").map(function(a){return d._normalizeRevision(a)}),c},this.ajax("_all_docs?include_docs=true","POST",e,{data:d}))},findQuery:function(a,b,c){var d,e;return d=c.designDoc||this.get("designDoc"),c.options||(c.options={}),c.options.include_docs=!0,e=function(a){var b,c=this;return b={},b[d]=a.rows.getEach("doc").map(function(a){return c._normalizeRevision(a)}),b},this.ajax("_design/%@/_view/%@".fmt(d,c.viewName),"GET",e,{context:this,data:c.options})},findAll:function(a,b){var c,d,e,f,g;return f=Ember.String.singularize(b.typeKey),d=this.get("designDoc")||f,g=this.get("typeViewName"),e=function(a){var c,d=this;return c={},c[[Ember.String.pluralize(b.typeKey)]]=a.rows.getEach("doc").map(function(a){return d._normalizeRevision(a)}),c},c={include_docs:!0,key:'"'+f+'"'},this.ajax("_design/%@/_view/%@".fmt(d,g),"GET",e,{data:c})},createRecord:function(a,b,c){var d;return d=a.serializerFor(b.typeKey).serialize(c),this._push(a,b,c,d)},updateRecord:function(a,b,c){var d;return d=this.serialize(c,{associations:!0,includeId:!0}),c.get("attachments")&&this._updateAttachmnets(c,d),this._push(a,b,c,d)},deleteRecord:function(a,b,c){return this.ajax("%@?rev=%@".fmt(c.get("id"),c.get("_data.rev")),"DELETE",function(){},{})},_updateAttachmnets:function(a,b){var c;return c={},a.get("attachments").forEach(function(a){var b;return b=EmberCouchDBKit.AttachmentStore.get(a.get("id")),c[a.get("file_name")]={content_type:b.content_type,digest:b.digest,length:b.length,stub:b.stub,revpos:b.revpos}}),b._attachments=c,delete b.attachments,delete b.history},_checkForRevision:function(a){return a.split("/").length>1},_push:function(a,b,c,d){var e,f,g;return e=c.get("id")||"",f=c.get("id")?"PUT":"POST",c.get("_data.rev")&&(d._rev=c.get("_data.rev")),g=function(a){var c,e;return c=d||{},this._normalizeRevision(a),e={},e[b.typeKey]=$.extend(c,a),e},this.ajax(e,f,g,{data:d})}})}.call(this),function(){var a,b,c,d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};EmberCouchDBKit.BaseRegistry=function(){function a(){this.registiry={}}return a.prototype.add=function(a,b){return this.registiry[a]=b},a.prototype.get=function(a){return this.registiry[a]},a.prototype.remove=function(){return delete this.registiry[key]},a}(),EmberCouchDBKit.RevsStoreClass=function(b){function c(){return a=c.__super__.constructor.apply(this,arguments)}return e(c,b),c.prototype.mapRevIds=function(a){var b=this;return this.get(a)._revs_info.map(function(c){return"%@/%@".fmt(b.get(a)._id,c.rev)})},c}(EmberCouchDBKit.BaseRegistry),EmberCouchDBKit.RevsStore=new EmberCouchDBKit.RevsStoreClass,EmberCouchDBKit.AttachmentStoreClass=function(a){function c(){return b=c.__super__.constructor.apply(this,arguments)}return e(c,a),c}(EmberCouchDBKit.BaseRegistry),EmberCouchDBKit.AttachmentStore=new EmberCouchDBKit.AttachmentStoreClass,EmberCouchDBKit.ChangesWorkersClass=function(a){function b(){return c=b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.stopAll=function(){var a,b,c,d;c=this.registiry,d=[];for(a in c)b=c[a],d.push(b.stop());return d},b}(EmberCouchDBKit.BaseRegistry),EmberCouchDBKit.ChangesWorkers=new EmberCouchDBKit.ChangesWorkersClass}.call(this),function(){EmberCouchDBKit.RevSerializer=DS.RESTSerializer.extend({primaryKey:"id",normalize:function(a,b,c){return this.normalizeRelationships(a,b),this._super(a,b,c)},extractId:function(a,b){return b._id||b.id},normalizeRelationships:function(a,b){return a.eachRelationship(function(c,d){return"belongsTo"===d.kind&&(b[c]=EmberCouchDBKit.RevsStore.mapRevIds(this.extractId(a,b))[1]),"hasMany"===d.kind?b[c]=EmberCouchDBKit.RevsStore.mapRevIds(this.extractId(a,b)):void 0},this)}}),EmberCouchDBKit.RevAdapter=DS.Adapter.extend({find:function(a,b,c){return this.ajax("%@?revs_info=true".fmt(c.split("/")[0]),"GET",{context:this},c)},updateRecord:function(){},deleteRecord:function(){},ajax:function(a,b,c,d){return this._ajax("%@/%@".fmt(this.buildURL(),a||""),b,c,d)},_ajax:function(a,b,c,d){return c.url=a,c.type=b,c.dataType="json",c.contentType="application/json; charset=utf-8",c.context=this,c.data&&"GET"!==b&&(c.data=JSON.stringify(c.data)),new Ember.RSVP.Promise(function(a){return c.success=function(b){return EmberCouchDBKit.RevsStore.add(d,b),Ember.run(null,a,{history:{id:d}})},Ember.$.ajax(c)})},buildURL:function(){var a,b,c;return a=Ember.get(this,"host"),b=Ember.get(this,"namespace"),c=[],a&&c.push(a),b&&c.push(b),c.push(this.get("db")),c=c.join("/"),a||(c="/"+c),c}})}.call(this);